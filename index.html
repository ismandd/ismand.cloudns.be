<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Phone Auth with Visible reCAPTCHA</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 400px;
      margin: 20px auto;
      padding: 10px;
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    label, select, input, button {
      display: block;
      width: 100%;
      margin: 8px 0;
      padding: 8px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    #recaptcha-container {
      margin-top: 15px;
      margin-bottom: 15px;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .flex-row {
      display: flex;
      gap: 8px;
    }
    .flex-row > * {
      flex: 1;
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, signInWithPhoneNumber, RecaptchaVerifier, PhoneAuthProvider } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID",
      databaseURL: "YOUR_DATABASE_URL"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    let retryCount = 0;
    let retryTimeout;

    window.onload = () => {
      // Setup visible reCAPTCHA
      window.recaptchaVerifier = new RecaptchaVerifier('recaptcha-container', {
        'size': 'normal',
        'callback': (response) => {
          console.log('reCAPTCHA solved');
        },
        'expired-callback': () => {
          console.log('reCAPTCHA expired, resetting');
          window.recaptchaVerifier.reset();
        }
      }, auth);

      window.recaptchaVerifier.render().then(widgetId => {
        console.log("reCAPTCHA widget rendered:", widgetId);
      });

      const countryCode = document.getElementById('country-code');
      const phoneNumberInput = document.getElementById('phone-number');
      const sendCodeBtn = document.getElementById('send-code-btn');
      const verificationCodeInput = document.getElementById('verification-code');
      const verifyCodeBtn = document.getElementById('verify-code-btn');
      const retryBtn = document.getElementById('retry-btn');
      const statusMsg = document.getElementById('status-msg');

      verificationCodeInput.disabled = true;
      verifyCodeBtn.disabled = true;
      retryBtn.disabled = true;

      function updateStatus(msg, isError = false) {
        statusMsg.textContent = msg;
        statusMsg.style.color = isError ? "red" : "green";
      }

      sendCodeBtn.onclick = () => {
        const phoneNumber = countryCode.value + phoneNumberInput.value.trim();
        if (!phoneNumberInput.value.match(/^\d{6,15}$/)) {
          updateStatus("Enter a valid phone number (6-15 digits)", true);
          return;
        }
        sendCodeBtn.disabled = true;
        updateStatus("Sending verification code...");

        signInWithPhoneNumber(auth, phoneNumber, window.recaptchaVerifier)
          .then((confirmationResult) => {
            window.confirmationResult = confirmationResult;
            updateStatus("Verification code sent! Check your phone.");
            verificationCodeInput.disabled = false;
            verifyCodeBtn.disabled = false;

            // Enable retry button after 30 seconds (if retryCount < 5)
            retryTimeout = setTimeout(() => {
              if (retryCount < 5) {
                retryBtn.disabled = false;
                updateStatus("You can retry sending the code now.");
              }
            }, 30000);

          }).catch((error) => {
            updateStatus("Error sending code: " + error.message, true);
            sendCodeBtn.disabled = false;
            window.recaptchaVerifier.reset();
          });
      };

      verifyCodeBtn.onclick = () => {
        const code = verificationCodeInput.value.trim();
        if (!code.match(/^\d{6}$/)) {
          updateStatus("Enter a valid 6-digit code", true);
          return;
        }
        updateStatus("Verifying code...");
        verifyCodeBtn.disabled = true;

        window.confirmationResult.confirm(code).then((result) => {
          const user = result.user;
          updateStatus(`Phone verified! Logged in as ${user.phoneNumber}`);
          verifyCodeBtn.disabled = true;
          sendCodeBtn.disabled = true;
          retryBtn.disabled = true;
          phoneNumberInput.disabled = true;
          countryCode.disabled = true;
          verificationCodeInput.disabled = true;
        }).catch((error) => {
          updateStatus("Invalid code or expired. Try again.", true);
          verifyCodeBtn.disabled = false;
        });
      };

      retryBtn.onclick = () => {
        if (retryCount >= 5) {
          updateStatus("Maximum retries reached.", true);
          retryBtn.disabled = true;
          return;
        }
        retryBtn.disabled = true;
        retryCount++;
        updateStatus(`Retrying to send code (${retryCount}/5)`);
        sendCodeBtn.disabled = false;
        verificationCodeInput.value = "";
        verifyCodeBtn.disabled = true;
        phoneNumberInput.focus();
      };
    };
  </script>
</head>
<body>
  <h2>Phone Number Verification</h2>
  <label for="country-code">Country Code:</label>
  <select id="country-code" aria-label="Select country code">
    <option value="+1">+1 USA</option>
    <option value="+44">+44 UK</option>
    <option value="+45" selected>+45 Denmark</option>
    <option value="+49">+49 Germany</option>
    <option value="+33">+33 France</option>
    <option value="+81">+81 Japan</option>
    <option value="+61">+61 Australia</option>
    <option value="+91">+91 India</option>
    <option value="+86">+86 China</option>
  </select>

  <label for="phone-number">Phone Number:</label>
  <input id="phone-number" type="tel" placeholder="Enter phone number (no country code)" />

  <button id="send-code-btn">Send Code</button>

  <div id="recaptcha-container"></div>

  <label for="verification-code">Verification Code:</label>
  <input id="verification-code" type="text" placeholder="6-digit code" maxlength="6" />

  <button id="verify-code-btn">Verify Code</button>
  <button id="retry-btn">Retry Sending Code</button>

  <p id="status-msg" aria-live="polite"></p>
</body>
</html>
