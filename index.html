<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Firebase Phone Auth Chat</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<h2>Phone Authentication Chat</h2>

<div id="auth-section">
  <label for="countryCode">Country Code:</label>
  <select id="countryCode" aria-label="Country Code">
    <option value="+1">ğŸ‡ºğŸ‡¸ +1 (USA)</option>
    <option value="+44">ğŸ‡¬ğŸ‡§ +44 (UK)</option>
    <option value="+45">ğŸ‡©ğŸ‡° +45 (Denmark)</option> <!-- Added Denmark -->
    <option value="+91">ğŸ‡®ğŸ‡³ +91 (India)</option>
    <option value="+61">ğŸ‡¦ğŸ‡º +61 (Australia)</option>
    <option value="+81">ğŸ‡¯ğŸ‡µ +81 (Japan)</option>
    <option value="+49">ğŸ‡©ğŸ‡ª +49 (Germany)</option>
    <option value="+33">ğŸ‡«ğŸ‡· +33 (France)</option>
    <option value="+7">ğŸ‡·ğŸ‡º +7 (Russia)</option>
  </select>

  <input
    id="phoneNumber"
    type="tel"
    placeholder="Phone number"
    pattern="[0-9]{6,15}"
    maxlength="15"
  />
  <button id="sendCodeBtn">Send Code</button>
  <button id="retryBtn" disabled>Retry</button>

  <br /><br />

  <input
    id="verificationCode"
    type="text"
    placeholder="Enter 6-digit code"
    pattern="[0-9]{6}"
    maxlength="6"
    disabled
  />
  <button id="verifyCodeBtn" disabled>Verify Code</button>
</div>

<div id="recaptcha-container"></div>

<div id="chat-section" style="display:none;">
  <div id="chat-messages" style="height:300px; overflow-y:auto; border:1px solid #ccc; padding:10px;"></div>
  <input id="chat-input" placeholder="Type a message" />
  <button id="send-message-btn">Send</button>
  <button id="logout-btn">Logout</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import {
    getAuth,
    RecaptchaVerifier,
    signInWithPhoneNumber,
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    getDatabase,
    ref,
    push,
    onChildAdded,
    serverTimestamp,
    query,
    orderByChild,
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

  // Your Firebase config here (replace with your actual config)
  const firebaseConfig = {
    apiKey: "AIzaSyCdOdsdiClQ-Ef4uADX2gglOl04CulpYrE",
    authDomain: "ismand-cloudns-be.firebaseapp.com",
    databaseURL:
      "https://ismand-cloudns-be-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "ismand-cloudns-be",
    storageBucket: "ismand-cloudns-be.appspot.com",
    messagingSenderId: "225354161393",
    appId: "1:225354161393:web:d51871c9e27b2d6ace1d50",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // UI elements
  const countryCode = document.getElementById("countryCode");
  const phoneNumberInput = document.getElementById("phoneNumber");
  const sendCodeBtn = document.getElementById("sendCodeBtn");
  const retryBtn = document.getElementById("retryBtn");
  const verificationCodeInput = document.getElementById("verificationCode");
  const verifyCodeBtn = document.getElementById("verifyCodeBtn");

  const chatSection = document.getElementById("chat-section");
  const chatMessages = document.getElementById("chat-messages");
  const chatInput = document.getElementById("chat-input");
  const sendMessageBtn = document.getElementById("send-message-btn");
  const logoutBtn = document.getElementById("logout-btn");

  const authSection = document.getElementById("auth-section");

  // State variables for retry control
  let retryCount = 0;
  let retryTimeout;

  // Initialize invisible reCAPTCHA
  window.recaptchaVerifier = new RecaptchaVerifier(
    "recaptcha-container",
    {
      size: "invisible",
      callback: (response) => {
        // reCAPTCHA solved - will allow sendCode to proceed
      },
      "expired-callback": () => {
        alert("reCAPTCHA expired, please try again.");
        sendCodeBtn.disabled = false;
      },
    },
    auth
  );

  // Send verification code
  sendCodeBtn.addEventListener("click", () => {
    const fullPhoneNumber = countryCode.value + phoneNumberInput.value.trim();

    if (!phoneNumberInput.value.match(/^\d{6,15}$/)) {
      alert("Please enter a valid phone number (6-15 digits).");
      return;
    }

    sendCodeBtn.disabled = true;

    signInWithPhoneNumber(auth, fullPhoneNumber, window.recaptchaVerifier)
      .then((confirmationResult) => {
        window.confirmationResult = confirmationResult;
        alert("Verification code sent!");
        verificationCodeInput.disabled = false;
        verifyCodeBtn.disabled = false;

        // Enable retry after 30 seconds if attempts left
        retryTimeout = setTimeout(() => {
          if (retryCount < 5) {
            retryBtn.disabled = false;
          }
        }, 30000);
      })
      .catch((error) => {
        console.error(error);
        alert("Error sending code: " + error.message);
        sendCodeBtn.disabled = false;
        window.recaptchaVerifier.render().then((widgetId) => {
          grecaptcha.reset(widgetId);
        });
      });
  });

  // Retry button logic
  retryBtn.addEventListener("click", () => {
    if (retryCount >= 5) {
      alert("Retry limit reached.");
      retryBtn.disabled = true;
      return;
    }

    retryBtn.disabled = true;
    retryCount++;
    sendCodeBtn.disabled = false;
    alert(`Retry attempt ${retryCount} of 5 allowed.`);
  });

  // Verify code entered by user
  verifyCodeBtn.addEventListener("click", () => {
    const code = verificationCodeInput.value.trim();

    if (!code.match(/^\d{6}$/)) {
      alert("Please enter the 6-digit code.");
      return;
    }

    verifyCodeBtn.disabled = true;

    window.confirmationResult
      .confirm(code)
      .then((result) => {
        alert("Phone number verified successfully!");
        authSection.style.display = "none";
        chatSection.style.display = "block";
        loadMessages();
      })
      .catch((error) => {
        alert("Incorrect code. Please try again.");
        console.error(error);
        verifyCodeBtn.disabled = false;
      });
  });

  // Load and listen for new messages
  function loadMessages() {
    chatMessages.innerHTML = "";
    const messagesRef = query(ref(db, "messages"), orderByChild("timestamp"));

    onChildAdded(messagesRef, (snapshot) => {
      const message = snapshot.val();
      const msgEl = document.createElement("div");
      const time = new Date(message.timestamp).toLocaleTimeString();
      msgEl.textContent = `[${time}] ${message.username}: ${message.text}`;
      chatMessages.appendChild(msgEl);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });
  }

  // Send chat message
  sendMessageBtn.addEventListener("click", () => {
    const text = chatInput.value.trim();
    const user = auth.currentUser;

    if (!text) return;
    if (!user) {
      alert("You must be logged in to send messages.");
      return;
    }

    push(ref(db, "messages"), {
      username: user.phoneNumber,
      text,
      timestamp: serverTimestamp(),
    });

    chatInput.value = "";
  });

  // Log out user
  logoutBtn.addEventListener("click", () => {
    signOut(auth)
      .then(() => {
        chatSection.style.display = "none";
        authSection.style.display = "block";
        phoneNumberInput.value = "";
        verificationCodeInput.value = "";
        verificationCodeInput.disabled = true;
        verifyCodeBtn.disabled = true;
        retryBtn.disabled = true;
        retryCount = 0;
        sendCodeBtn.disabled = false;
      })
      .catch((error) => {
        alert("Error logging out: " + error.message);
      });
  });

  // Keep chat if user is already logged in
  onAuthStateChanged(auth, (user) => {
    if (user) {
      authSection.style.display = "none";
      chatSection.style.display = "block";
      loadMessages();
    } else {
      authSection.style.display = "block";
      chatSection.style.display = "none";
      verificationCodeInput.disabled = true;
      verifyCodeBtn.disabled = true;
      retryBtn.disabled = true;
      retryCount = 0;
      sendCodeBtn.disabled = false;
    }
  });
</script>
</body>
</html>
