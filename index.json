<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simple Firebase Chat</title>
<link rel="stylesheet" href="style.css" />
</head>
<body>

<h2>Simple Firebase Chat</h2>
<div id="usernameDisplay"></div>
<div id="chat"></div>
<div id="inputArea">
  <input id="messageInput" type="text" placeholder="Type your message..." autocomplete="off" />
  <button id="sendBtn">Send</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCdOdsdiClQ-Ef4uADX2gglOl04CulpYrE",
    authDomain: "ismand-cloudns-be.firebaseapp.com",
    databaseURL: "https://ismand-cloudns-be-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "ismand-cloudns-be",
    storageBucket: "ismand-cloudns-be.firebasestorage.app",
    messagingSenderId: "225354161393",
    appId: "1:225354161393:web:d51871c9e27b2d6ace1d50"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const messagesRef = ref(db, "messages");

  const username = "User" + Math.floor(Math.random() * 9000 + 1000);
  document.getElementById("usernameDisplay").textContent = `You are: ${username}`;

  const chatEl = document.getElementById("chat");
  const inputEl = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");

  // Track displayed messages to avoid duplicates from optimistic UI
  const displayedMessages = new Set();

  function addMessage(data) {
    const { username: user, text, timestamp } = data;
    const uniqueId = `${user}-${text}-${timestamp || ''}`;

    if (displayedMessages.has(uniqueId)) return;
    displayedMessages.add(uniqueId);

    const msgDiv = document.createElement("div");

    const userSpan = document.createElement("span");
    userSpan.classList.add("username");
    userSpan.textContent = user + ":";

    const textSpan = document.createElement("span");
    textSpan.classList.add("message");
    textSpan.textContent = " " + text;

    msgDiv.appendChild(userSpan);
    msgDiv.appendChild(textSpan);
    chatEl.appendChild(msgDiv);

    chatEl.scrollTop = chatEl.scrollHeight;
  }

  // Listen for new messages from Firebase
  onChildAdded(messagesRef, (snapshot) => {
    addMessage(snapshot.val());
  });

  function sendMessage() {
    const text = inputEl.value.trim();
    if (text === "") return;

    // Optimistic UI: show message immediately with temporary timestamp
    const tempTimestamp = Date.now();
    addMessage({ username, text, timestamp: tempTimestamp });

    // Send to Firebase
    push(messagesRef, {
      username,
      text,
      timestamp: serverTimestamp()
    });

    inputEl.value = "";
    inputEl.focus();
  }

  sendBtn.addEventListener("click", sendMessage);
  inputEl.addEventListener("keypress", (e) => {
    if (e.key === "Enter") sendMessage();
  });
</script>

</body>
</html>
